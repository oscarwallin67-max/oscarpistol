<!DOCTYPE html>
<html lang="sv">
<head>

<meta charset="UTF-8" />
<title>PistolApp â€“ Serie registrering</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
    margin: 0;
    background: #f0f2f5;
    color: #111;
  }

  .page { display: none; padding: 20px; max-width: 520px; margin: auto; }
  .show { display: block !important; }
  h1, h2 { text-align: center; margin: 16px 0 20px; }

  .quick-btn {
    width: 100%; padding: 22px; font-size: 1.3rem; color:#fff;
    border-radius: 18px; margin-bottom: 14px; border:none; cursor:pointer;
    font-weight:700; background:linear-gradient(135deg,#1e88e5,#26c6da);
    box-shadow:0 4px 10px rgba(0,0,0,0.15);
  }
  .quick-btn.green {
    background:linear-gradient(135deg,#43a047,#66bb6a);
  }

  .log-btn {
    width:100%; padding:22px; font-size:1.3rem; border:none;
    border-radius:18px; margin-top:10px; color:#fff; cursor:pointer;
    background:linear-gradient(135deg,#7e57c2,#ab47bc);
    font-weight:700;
  }

  label { font-weight:600; display:block; margin-top:14px; }
  input, select {
    width:100%; padding:12px; border-radius:12px;
    border:1px solid #ccc; margin-top:4px; font-size:1rem;
  }

  .shot-grid {
    display:grid; grid-template-columns:repeat(3,1fr);
    gap:14px; margin-top:20px;
  }
  .shot-btn {
    padding:20px; background:#0d47a1; color:#fff; font-size:1.6rem;
    border:none; border-radius:14px; cursor:pointer; font-weight:700;
  }

  .small-row { display:flex; gap:10px; margin:18px 0; }
  .small-btn {
    flex:1; padding:16px; border:none; border-radius:12px;
    font-size:1.1rem; font-weight:700; cursor:pointer;
  }
  .undo-btn { background:#ffb300; color:#212121; }
  .clear-btn { background:#c62828; color:#fff; }

  .save-btn {
    width:100%; padding:20px; margin-top:10px; background:#1976d2;
    color:#fff; font-size:1.3rem; border:none; border-radius:16px;
    font-weight:700; cursor:pointer;
  }

  .nav-back {
    width:100%; margin-top:14px; padding:16px;
    font-size:1rem; border:none; border-radius:12px;
    background:#ddd; cursor:pointer; font-weight:600;
  }

  .log-card {
    background:#fff; padding:12px 14px; border-radius:14px;
    margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.12);
  }
  .log-top { font-weight:700; margin-bottom:4px; }
  .log-sub { color:#555; font-size:0.9rem; }
  .log-shots { margin-top:6px; font-weight:600; }
  .log-delete {
    margin-top:6px; border:none; background:#c62828;
    color:#fff; border-radius:999px; padding:6px 10px;
    cursor:pointer; font-size:0.85rem;
  }
</style>
</head>

<body>

<!-- START -->
<div id="pageStart" class="page show">
  <h1>Pistolskytte Logg</h1>

  <button class="quick-btn"
    onclick="quickStart('Pistol','.22','Precision 25 m â€“ 5 skott','Berget')">
    .22 B â€“ Precision
  </button>

  <button class="quick-btn"
    onclick="quickStart('Pistol','9mm','Precision 25 m â€“ 5 skott','Berget')">
    9mm B â€“ Precision
  </button>

  <button class="quick-btn green"
    onclick="quickStart('Pistol','.22','Snabbserie 25 m â€“ 6 skott','Berget')">
    .22 B â€“ Snabbserie
  </button>

  <button class="quick-btn green"
    onclick="quickStart('Pistol','9mm','Snabbserie 25 m â€“ 6 skott','Berget')">
    9mm B â€“ Snabbserie
  </button>

  <button class="log-btn" onclick="openLogbook()">ðŸ“’ Loggbok</button>
</div>


<!-- SERIE -->
<div id="pageSeries" class="page">
  <h2>Registrera serie</h2>

  <label>Datum</label>
  <input type="date" id="dateField">

  <label>Plats</label>
  <select id="placeField">
    <option value="Berget">Berget</option>
    <option value="Grimsta">Grimsta</option>
    <option value="Annat">Annat</option>
  </select>

  <label>Vapen</label>
  <select id="weaponField">
    <option value="Pistol">Pistol</option>
    <option value="Revolver">Revolver</option>
  </select>

  <label>Kaliber</label>
  <select id="caliberField">
    <option value=".22">.22</option>
    <option value=".32">.32</option>
    <option value="9mm">9mm</option>
    <option value=".38 Special">.38 Special</option>
    <option value=".357 Magnum">.357 Magnum</option>
  </select>

  <label>Typ</label>
  <select id="typeField">
    <option value="Precision 25 m â€“ 5 skott">Precision 25 m â€“ 5 skott</option>
    <option value="Snabbserie 25 m â€“ 6 skott">Snabbserie 25 m â€“ 6 skott</option>
  </select>

  <label>Skott</label>
  <div id="shotList"></div>

  <label>PoÃ¤ng</label>
  <input id="scoreField" type="number" readonly>

  <label>Antal skott</label>
  <input id="shotsField" type="number" readonly>

  <div class="shot-grid">
    <button class="shot-btn">X</button>
    <button class="shot-btn">10</button>
    <button class="shot-btn">9</button>
    <button class="shot-btn">8</button>
    <button class="shot-btn">7</button>
    <button class="shot-btn">6</button>
    <button class="shot-btn">5</button>
    <button class="shot-btn">4</button>
    <button class="shot-btn">3</button>
    <button class="shot-btn">2</button>
    <button class="shot-btn">1</button>
    <button class="shot-btn">0</button>
  </div>

  <div class="small-row">
    <button class="small-btn undo-btn" onclick="undoShot()">âŸ² Ã…ngra</button>
    <button class="small-btn clear-btn" onclick="clearShots()">ðŸ—‘ Rensa</button>
  </div>

  <button class="save-btn" onclick="saveSeries()">Spara serie</button>
  <button class="nav-back" onclick="goHome()">â¬… Tillbaka</button>
</div>


<!-- LOGGBOK -->
<div id="pageLogbook" class="page">
  <h2>Loggbok</h2>
  <div id="logContainer"></div>
  <button class="save-btn" onclick="exportCSV()">ðŸ“¤ Exportera till Excel</button>
  <button class="nav-back" onclick="goHome()">â¬… Tillbaka</button>
</div>


<script>
let log = [];
let currentShots = [];
let totalScore = 0;
const KEY = "pistolapp_log_v1";


/* --- NY korrekt snabbstart utan URL-byten --- */
function quickStart(weapon, caliber, type, place) {

  document.getElementById("weaponField").value = weapon;
  document.getElementById("caliberField").value = caliber;
  document.getElementById("typeField").value = type;
  document.getElementById("placeField").value = place;
  document.getElementById("dateField").valueAsDate = new Date();

  currentShots = [];
  totalScore = 0;
  updateDisplay();

  showPage("pageSeries");
}


/* --- NÃ¤r sidan laddas --- */
document.addEventListener("DOMContentLoaded", () => {

  let saved = localStorage.getItem(KEY);
  if (saved) log = JSON.parse(saved);

  document.querySelectorAll(".shot-btn").forEach(btn => {
    btn.onclick = () => {
      if (currentShots.length >= getMaxShots()) return;
      let t = btn.textContent.trim();
      let v = (t === "X") ? 10 : Number(t);
      currentShots.push(t);
      totalScore += v;
      updateDisplay();
    };
  });
});


function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("show"));
  document.getElementById(id).classList.add("show");
}

function goHome(){ showPage("pageStart"); }

function getMaxShots(){
  let t = document.getElementById("typeField").value;
  return t.includes("Precision") ? 5 : 6;
}

function updateDisplay(){
  document.getElementById("shotList").textContent = currentShots.join(" â€“ ");
  document.getElementById("shotsField").value = currentShots.length;
  document.getElementById("scoreField").value = totalScore;
}

function undoShot(){
  if(currentShots.length === 0) return;
  let last = currentShots.pop();
  totalScore -= (last==="X") ? 10 : Number(last);
  updateDisplay();
}

function clearShots(){
  currentShots = [];
  totalScore = 0;
  updateDisplay();
}

function saveSeries(){
  if(currentShots.length !== getMaxShots()){
    alert("Du mÃ¥ste registrera exakt "+getMaxShots()+" skott!");
    return;
  }

  let entry = {
    id: Date.now(),
    date: document.getElementById("dateField").value,
    place: document.getElementById("placeField").value,
    weapon: document.getElementById("weaponField").value,
    caliber: document.getElementById("caliberField").value,
    type: document.getElementById("typeField").value,
    shots: [...currentShots],
    score: totalScore
  };

  log.push(entry);
  localStorage.setItem(KEY, JSON.stringify(log));

  alert("Serie sparad!");
  clearShots();
  goHome();
}

function openLogbook(){
  showPage("pageLogbook");
  renderLog();
}

function renderLog(){
  let box=document.getElementById("logContainer");
  box.innerHTML="";

  if(log.length===0){
    box.innerHTML="<p>Inga serier sparade Ã¤nnu.</p>";
    return;
  }

  [...log].reverse().forEach(e=>{
    let div=document.createElement("div");
    div.className="log-card";
    div.innerHTML=`
      <div class="log-top">${e.date} â€“ ${e.type}</div>
      <div class="log-sub">Vapen: ${e.weapon} | Kaliber: ${e.caliber} | Plats: ${e.place}</div>
      <div class="log-shots">Skott: ${e.shots.join(" â€“ ")}</div>
      <button class="log-delete" onclick="deleteEntry(${e.id})">Ta bort</button>
    `;
    box.appendChild(div);
  });
}

function deleteEntry(id){
  if(!confirm("Vill du ta bort serien?")) return;
  log = log.filter(x => x.id !== id);
  localStorage.setItem(KEY, JSON.stringify(log));
  renderLog();
}

function exportCSV(){
  if(log.length===0){ alert("Inga serier att exportera."); return; }

  let csv="\uFEFFDatum;Typ;Vapen;Kaliber;Plats;Skott;PoÃ¤ng\n";

  log.forEach(e=>{
    csv+=`${e.date};${e.type};${e.weapon};${e.caliber};${e.place};${e.shots.join("-")};${e.score}\n`;
  });

  let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url; a.download="pistolskytte_loggbok.csv"; a.click();
  URL.revokeObjectURL(url);
}

</script>

<!-- Serviceworker Registration -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
