<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<title>PistolApp ‚Äì Serie registrering</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">

<style>
  body { font-family: system-ui, sans-serif; margin:0; background:#f0f2f5; color:#111; }
  .page { display:none; padding:20px; max-width:520px; margin:auto; }
  .show { display:block !important; }

  h1, h2 { text-align:center; margin:10px 0 20px; }

  .big-btn {
    width:100%; padding:24px; font-size:1.4rem;
    border:none; border-radius:18px; color:#fff;
    margin-bottom:14px; font-weight:700;
    box-shadow:0 4px 10px rgba(0,0,0,0.18);
  }

  .btn-blue { background:linear-gradient(135deg,#1565c0,#1e88e5); }
  .btn-green { background:linear-gradient(135deg,#2e7d32,#43a047); }
  .btn-purple { background:linear-gradient(135deg,#5e35b1,#7e57c2); }

  /* Snabbknappar √∂verst */
  .quick-row {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-bottom:20px;
  }
  .quick-btn {
    padding:18px;
    background:#0d47a1;
    color:#fff;
    font-size:1.1rem;
    font-weight:700;
    border:none;
    border-radius:14px;
    box-shadow:0 2px 8px rgba(0,0,0,0.18);
  }

  .back-btn {
    width:100%; padding:18px;
    background:#e0e0e0;
    border-radius:14px;
    border:none;
    font-size:1.2rem;
    font-weight:700;
    margin-top:16px;
  }

  .series-grid {
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:12px; margin-top:20px;
  }
  .series-btn {
    padding:22px 0;
    background:#0d47a1;
    color:#fff;
    font-size:2rem;
    border:none;
    border-radius:14px;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
  }
</style>
</head>

<body>

<!-- START -->
<div id="pageStart" class="page show">

  <h1>Pistolskytte Logg</h1>

  <!-- SNABBKNAPPAR FOR PRECISION -->
  <div class="quick-row">
    <button class="quick-btn" onclick="quickPrecision('.22','Berget')">.22 B ‚Äì Precision</button>
    <button class="quick-btn" onclick="quickPrecision('9mm','Berget')">9mm B ‚Äì Precision</button>
  </div>

  <!-- SNABBKNAPPAR FOR SNABBSERIE -->
  <div class="quick-row">
    <button class="quick-btn" onclick="quickSnabb('.22','Berget')">.22 B ‚Äì Snabbserie</button>
    <button class="quick-btn" onclick="quickSnabb('9mm','Berget')">9mm B ‚Äì Snabbserie</button>
  </div>

  <!-- VANLIGA KNAPPAR -->
  <button class="big-btn btn-blue" onclick="chooseMode('precision')">Precision 25 m ‚Äì 5 skott</button>
  <button class="big-btn btn-green" onclick="chooseMode('snabb')">Snabbserie 25 m ‚Äì 6 skott</button>
  <button class="big-btn btn-purple" onclick="openLogbook()">üìí Loggbok</button>
  <button class="big-btn btn-purple" onclick="openStats()">üìä Statistik</button>
  <button class="big-btn btn-purple" onclick="openSettings()">‚öôÔ∏è Inst√§llningar</button>

</div>
<!-- SERIE-SIDA -->
<div id="pageSeries" class="page">

  <h2>Registrera serie</h2>

  <label>Datum</label>
  <input id="dateField" type="date">

  <label>Plats</label>
  <input id="placeField" type="text" readonly>

  <label>Vapen</label>
  <input id="weaponField" type="text" readonly>

  <label>Kaliber</label>
  <input id="caliberField" type="text" readonly>

  <label>Typ</label>
  <input id="modeField" type="text" readonly>

  <label>Skott:</label>
  <div id="shotList" class="shot-list"></div>

  <label>Po√§ng totalt</label>
  <input id="scoreField" type="number" readonly>

  <label>Antal skott</label>
  <input id="shotsField" type="number" readonly>

  <div class="series-grid">
    <button class="series-btn">X</button>
    <button class="series-btn">10</button>
    <button class="series-btn">9</button>
    <button class="series-btn">8</button>
    <button class="series-btn">7</button>
    <button class="series-btn">6</button>
    <button class="series-btn">5</button>
    <button class="series-btn">4</button>
    <button class="series-btn">3</button>
    <button class="series-btn">2</button>
    <button class="series-btn">1</button>
    <button class="series-btn">0</button>
  </div>

  <div style="display:flex; gap:12px; margin-top:16px;">
    <button class="big-btn btn-purple" onclick="undoShot()">‚ü≤ √Öngra</button>
    <button class="big-btn btn-purple" onclick="clearAllShots()">üóë Rensa</button>
  </div>

  <button class="big-btn btn-green" onclick="saveSeries()">Spara serie</button>
  <button class="back-btn" onclick="goHome()">‚¨Ö Tillbaka</button>

</div>

<!-- LJUD -->
<audio id="clickAudio" src="click.mp3" preload="auto"></audio>

<script>
/* ===========================
     VARIABLER
=========================== */
let mode = "";
let maxShots = 0;
let currentShots = [];
let totalScore = 0;

const clickSound = document.getElementById("clickAudio");
clickSound.volume = 0.4;

/* ===========================
     SNABBKNAPPAR
=========================== */
function quickPrecision(kaliber, plats) {
  mode = "precision";
  maxShots = 5;

  document.getElementById("weaponField").value = "Pistol";
  document.getElementById("caliberField").value = kaliber;
  document.getElementById("placeField").value = plats;
  document.getElementById("modeField").value = "Precision 25 m ‚Äì 5 skott";
  document.getElementById("dateField").valueAsDate = new Date();

  currentShots = [];
  totalScore = 0;
  updateDisplay();

  showPage("pageSeries");
}

function quickSnabb(kaliber, plats) {
  mode = "snabb";
  maxShots = 6;

  document.getElementById("weaponField").value = "Pistol";
  document.getElementById("caliberField").value = kaliber;
  document.getElementById("placeField").value = plats;
  document.getElementById("modeField").value = "Snabbserie 25 m ‚Äì 6 skott";
  document.getElementById("dateField").valueAsDate = new Date();

  currentShots = [];
  totalScore = 0;
  updateDisplay();

  showPage("pageSeries");
}

/* ===========================
     VAL VIA MENY (vanliga knappar)
=========================== */
function chooseMode(m) {
  mode = m;
  maxShots = (m === "precision" ? 5 : 6);
  currentShots = [];
  totalScore = 0;
  showPage("pageWeapon");
}

function chooseWeapon(w) {
  document.getElementById("weaponField").value = w;
  showPage("pageCaliber");
}

function chooseCaliber(c) {
  document.getElementById("caliberField").value = c;
  document.getElementById("placeField").value = "";
  document.getElementById("dateField").valueAsDate = new Date();

  document.getElementById("modeField").value =
    mode === "precision"
      ? "Precision 25 m ‚Äì 5 skott"
      : "Snabbserie 25 m ‚Äì 6 skott";

  currentShots = [];
  totalScore = 0;
  updateDisplay();
  showPage("pageSeries");
}

/* ===========================
     SKOTTINSKRIVNING
=========================== */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".series-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      if (currentShots.length >= maxShots) return;

      let label = btn.textContent.trim();
      let scoreValue = (label === "X" ? 10 : Number(label));

      currentShots.push(label);
      totalScore += scoreValue;

      clickSound.currentTime = 0;
      clickSound.play();

      updateDisplay();
    });
  });
});

function updateDisplay() {
  document.getElementById("shotList").textContent = currentShots.join(" ‚Äì ");
  document.getElementById("shotsField").value = currentShots.length;
  document.getElementById("scoreField").value = totalScore;
}

function undoShot() {
  if (currentShots.length === 0) return;

  let last = currentShots.pop();
  let v = (last === "X" ? 10 : Number(last));

  totalScore -= v;
  updateDisplay();
}

function clearAllShots() {
  currentShots = [];
  totalScore = 0;
  updateDisplay();
}
<!-- LOGGBOK -->
<div id="pageLogbook" class="page">
  <h2>Loggbok</h2>
  <div id="logContainer"></div>

  <button class="big-btn btn-green" onclick="exportCSV()">üì§ Exportera CSV</button>
  <button class="back-btn" onclick="goHome()">‚¨Ö Tillbaka</button>
</div>

<!-- STATISTIK -->
<div id="pageStats" class="page">
  <h2>üìä Statistik</h2>

  <div id="statsBox" style="
    background:#fff; padding:14px; border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,0.15);
    font-size:1.1rem; line-height:1.6;">
  </div>

  <button class="back-btn" onclick="goHome()">‚¨Ö Tillbaka</button>
</div>

<!-- INST√ÑLLNINGAR -->
<div id="pageSettings" class="page">
  <h2>‚öôÔ∏è Inst√§llningar</h2>

  <label>
    <input type="checkbox" id="soundToggle" checked>
    Aktivera klick-ljud
  </label>

  <label>
    <input type="checkbox" id="vibrationToggle">
    Aktivera vibration (om mobil st√∂djer)
  </label>

  <button class="big-btn btn-purple" onclick="resetAll()">üóë Nollst√§ll hela loggboken</button>
  <button class="back-btn" onclick="goHome()">‚¨Ö Tillbaka</button>
</div>

<script>
/* ============================================================================
     LOCALSTORAGE ‚Äì LOGGBOK
============================================================================ */
const STORAGE_KEY = "pistolskytte_logg_v7";
let logbook = [];

function loadLogbook() {
  let s = localStorage.getItem(STORAGE_KEY);
  if (s) {
    try { logbook = JSON.parse(s); }
    catch { logbook = []; }
  }
}

function saveLogbook() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(logbook));
}

/* ============================================================================
     NAVIGATION
============================================================================ */
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
  document.getElementById(id).classList.add('show');
}

function goHome() {
  showPage("pageStart");
}

function openLogbook() {
  renderLogbook();
  showPage("pageLogbook");
}

function openStats() {
  updateStats();
  showPage("pageStats");
}

function openSettings() {
  showPage("pageSettings");
}

/* ============================================================================
     LOGGBOK ‚Äì RENDERING
============================================================================ */
function renderLogbook() {
  let cont = document.getElementById("logContainer");
  cont.innerHTML = "";

  if (logbook.length === 0) {
    cont.innerHTML = "<p>Inga serier sparade √§nnu.</p>";
    return;
  }

  let sorted = [...logbook].sort((a, b) => b.id - a.id);

  sorted.forEach(e => {
    let div = document.createElement("div");
    div.className = "log-card";
    div.style = `
      background:#fff; padding:14px; border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.12);
      margin-bottom:12px;
    `;

    div.innerHTML = `
      <strong>${e.date} ‚Äì ${e.type}</strong><br>
      <small>Vapen: ${e.weapon} | Kaliber: ${e.caliber} | Plats: ${e.place}</small><br>
      <small>Skott: ${e.shots.join(" ‚Äì ")}</small><br>
      <strong>Total: ${e.score}p</strong><br><br>
      <button onclick="deleteEntry(${e.id})"
        style="background:#c62828; color:#fff; padding:6px 10px;
        border:none; border-radius:999px;">Ta bort</button>
    `;

    cont.appendChild(div);
  });
}

function deleteEntry(id) {
  if (!confirm("Vill du verkligen ta bort denna serie?")) return;
  logbook = logbook.filter(e => e.id !== id);
  saveLogbook();
  renderLogbook();
}

/* ============================================================================
     CSV EXPORT
============================================================================ */
function exportCSV() {
  if (logbook.length === 0) {
    alert("Inga serier att exportera.");
    return;
  }

  let csv = "\uFEFFDatum;Typ;Vapen;Kaliber;Plats;Skott;Po√§ng\n";

  logbook.forEach(e => {
    let s = e.shots.join("-");
    let typeClean = e.type.replace("‚Äì", "-");
    csv += `${e.date};${typeClean};${e.weapon};${e.caliber};${e.place};${s};${e.score}\n`;
  });

  let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "pistolskytte_loggbok.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ============================================================================
     STATISTIK
============================================================================ */
function updateStats() {
  loadLogbook();

  if (logbook.length === 0) {
    document.getElementById("statsBox").innerHTML = "Ingen data √§nnu.";
    return;
  }

  let total = logbook.length;
  let best = Math.max(...logbook.map(e => e.score));
  let avg = (logbook.reduce((a, b) => a + b.score, 0) / total).toFixed(1);

  document.getElementById("statsBox").innerHTML = `
    <strong>Totalt antal serier:</strong> ${total}<br>
    <strong>Genomsnittspo√§ng:</strong> ${avg}<br>
    <strong>B√§sta serie:</strong> ${best} po√§ng<br>
  `;
}
/* ============================================================================
     SPARA SERIE
============================================================================ */
function saveSeries() {
  if (currentShots.length !== maxShots) {
    alert("Du m√•ste registrera exakt " + maxShots + " skott!");
    return;
  }

  let entry = {
    id: Date.now(),
    date: document.getElementById("dateField").value,
    place: document.getElementById("placeField").value,
    weapon: document.getElementById("weaponField").value,
    caliber: document.getElementById("caliberField").value,
    type: document.getElementById("modeField").value,
    shots: [...currentShots],
    score: totalScore
  };

  logbook.push(entry);
  saveLogbook();

  alert("Serie sparad!");

  currentShots = [];
  totalScore = 0;
  updateDisplay();
}

/* ============================================================================
     INST√ÑLLNINGAR ‚Äì LJUD / VIBRATION
============================================================================ */
document.getElementById("soundToggle").addEventListener("change", (e) => {
  clickSound.volume = e.target.checked ? 0.4 : 0.0;
});

document.getElementById("vibrationToggle").addEventListener("change", (e) => {
  if (e.target.checked) {
    if (navigator.vibrate) navigator.vibrate(20);
  }
});

/* ============================================================================
     NOLLST√ÑLLA HELA LOGGBOKEN
============================================================================ */
function resetAll() {
  if (!confirm("Vill du verkligen nollst√§lla ALLA sparade serier?")) return;
  logbook = [];
  saveLogbook();
  alert("Loggboken √§r nu tom.");
}

/* ============================================================================
     VID START
============================================================================ */
loadLogbook();
</script>

</body>
</html>
