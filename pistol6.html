<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<title>PistolApp â€“ Serie registrering</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { font-family: system-ui, sans-serif; margin: 0; background:#f0f2f5; color:#111; }
  .page { display:none; padding:20px; max-width:520px; margin:auto; }
  .show { display:block !important; }

  h1, h2 { text-align:center; margin:10px 0 20px; }

  .big-btn {
    width:100%; padding:24px; font-size:1.4rem;
    border:none; border-radius:18px; color:#fff;
    cursor:pointer; margin-bottom:16px; font-weight:700;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
  }
  .prec-btn { background:linear-gradient(135deg, #1565c0, #1e88e5); }
  .snabb-btn { background:linear-gradient(135deg, #2e7d32, #43a047); }
  .log-btn { background:linear-gradient(135deg, #6a1b9a, #8e24aa); }

  .choice-btn {
    width:100%; padding:20px; font-size:1.3rem;
    background:#1976d2; color:white; border:none;
    border-radius:16px; margin-bottom:12px; cursor:pointer;
  }

  .nav-back {
    width:100%; padding:14px; border:none;
    background:#e0e0e0; border-radius:12px; cursor:pointer;
  }

  label { font-weight:600; margin-top:14px; display:block; }
  input, select {
    width:100%; padding:12px; margin-top:6px;
    border-radius:10px; border:1px solid #ccc;
  }

  .shot-list {
    text-align:center; background:#fff; padding:16px;
    font-size:1.6rem; border-radius:14px;
    margin:12px 0; box-shadow:0 2px 6px rgba(0,0,0,0.12);
  }

  .series-grid {
    display:grid; grid-template-columns:repeat(3,1fr);
    gap:12px; margin:20px 0;
  }

  .series-btn {
    padding:22px 0; font-size:2rem; font-weight:700;
    background:#0d47a1; color:#fff; border:none;
    border-radius:16px; cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
  }

  .small-btn {
    width:50%; padding:14px; border:none; border-radius:12px;
    font-size:1.1rem; font-weight:700; cursor:pointer;
  }
  .undo-btn { background:#ffb300; }
  .clear-btn { background:#c62828; color:white; }

  .save-btn {
    width:100%; padding:18px; font-size:1.2rem;
    background:#1976d2; color:white; border:none;
    margin-top:20px; border-radius:16px; cursor:pointer;
  }

  /* LOGBOOK */
  #logContainer { display:flex; flex-direction:column; gap:16px; }
  .log-card {
    background:white; padding:14px; border-radius:14px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
  }
  .log-delete-btn {
    background:#c62828; border:none; color:white;
    border-radius:999px; padding:6px 12px; cursor:pointer;
  }
</style>
</head>

<body>

<!-- START -->
<div id="pageStart" class="page show">
  <h1>Pistolskytte Logg</h1>
  <button class="big-btn prec-btn" onclick="chooseMode('precision')">Precision â€“ 5 skott</button>
  <button class="big-btn snabb-btn" onclick="chooseMode('snabb')">Snabbserie â€“ 6 skott</button>
  <button class="big-btn log-btn" onclick="openLogbook()">ðŸ“’ Loggbok</button>
</div>

<!-- VAPEN -->
<div id="pageWeapon" class="page">
  <h2>VÃ¤lj vapen</h2>
  <button class="choice-btn" onclick="chooseWeapon('Pistol')">Pistol</button>
  <button class="choice-btn" onclick="chooseWeapon('Revolver')">Revolver</button>
  <button class="nav-back" onclick="goHome()">â¬… Tillbaka</button>
</div>

<!-- KALIBER -->
<div id="pageCaliber" class="page">
  <h2>VÃ¤lj kaliber</h2>
  <button class="choice-btn" onclick="chooseCaliber('.22')">.22</button>
  <button class="choice-btn" onclick="chooseCaliber('.32')">.32</button>
  <button class="choice-btn" onclick="chooseCaliber('9mm')">9mm</button>
  <button class="choice-btn" onclick="chooseCaliber('.38 Special')">.38 Special</button>
  <button class="choice-btn" onclick="chooseCaliber('.357 Magnum')">.357 Magnum</button>
  <button class="nav-back" onclick="goHome()">â¬… Tillbaka</button>
</div>

<!-- SERIES -->
<div id="pageSeries" class="page">
  <h2>Registrera serie</h2>

  <label>Datum</label>
  <input id="dateField" type="date">

  <label>Plats</label>
  <select id="placeField">
    <option value="Berget">Berget</option>
    <option value="Grimsta">Grimsta</option>
    <option value="Annat">Annat</option>
  </select>

  <label>Vapen</label>
  <input id="weaponField" type="text" readonly>

  <label>Kaliber</label>
  <input id="caliberField" type="text" readonly>

  <label>Typ</label>
  <input id="modeField" type="text" readonly>

  <label>Skott:</label>
  <div id="shotList" class="shot-list"></div>

  <label>PoÃ¤ng</label>
  <input id="scoreField" type="number" readonly>

  <label>Antal skott</label>
  <input id="shotsField" type="number" readonly>

  <div class="series-grid">
    <button class="series-btn">X</button>
    <button class="series-btn">10</button>
    <button class="series-btn">9</button>
    <button class="series-btn">8</button>
    <button class="series-btn">7</button>
    <button class="series-btn">6</button>
    <button class="series-btn">5</button>
    <button class="series-btn">4</button>
    <button class="series-btn">3</button>
    <button class="series-btn">2</button>
    <button class="series-btn">1</button>
    <button class="series-btn">0</button>
  </div>

  <div style="display:flex; gap:10px;">
    <button class="small-btn undo-btn" onclick="undoShot()">âŸ² Ã…ngra</button>
    <button class="small-btn clear-btn" onclick="clearAllShots()">ðŸ—‘ Rensa</button>
  </div>

  <button class="save-btn" onclick="saveSeries()">Spara serie</button>
  <button class="nav-back" onclick="goHome()">â¬… Tillbaka</button>
</div>

<!-- LOGBOOK -->
<div id="pageLogbook" class="page">
  <h2>Loggbok</h2>
  <div id="logContainer"></div>
  <button class="save-btn" onclick="exportCSV()">ðŸ“¤ Exportera</button>
  <button class="nav-back" onclick="goHome()">â¬… Tillbaka</button>
</div>

<script>
const STORAGE_KEY = "pistolskytte_logg_v6";
let logbook = [];
let mode = "";
let maxShots = 0;
let currentShots = [];
let totalScore = 0;

document.addEventListener("DOMContentLoaded", () => {

  loadLogbook();

  document.querySelectorAll(".series-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (currentShots.length >= maxShots) return;

      let label = btn.textContent.trim();
      let scoreValue = (label === "X") ? 10 : Number(label);

      currentShots.push(label);
      totalScore += scoreValue;

      updateDisplay();
    });
  });
});

function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("show"));
  document.getElementById(id).classList.add("show");
}

function goHome() {
  showPage("pageStart");
}

function chooseMode(m) {
  mode = m;
  maxShots = (m === "precision" ? 5 : 6);
  currentShots = [];
  totalScore = 0;
  showPage("pageWeapon");
}

function chooseWeapon(w) {
  document.getElementById("weaponField").value = w;
  showPage("pageCaliber");
}

function chooseCaliber(c) {
  document.getElementById("caliberField").value = c;

  document.getElementById("modeField").value =
    (mode === "precision"
      ? "Precision 25 m â€“ 5 skott"
      : "Snabbserie 25 m â€“ 6 skott");

  document.getElementById("dateField").valueAsDate = new Date();

  currentShots = [];
  totalScore = 0;

  updateDisplay();
  showPage("pageSeries");
}

function updateDisplay() {
  document.getElementById("shotList").textContent = currentShots.join(" â€“ ");
  document.getElementById("shotsField").value = currentShots.length;
  document.getElementById("scoreField").value = totalScore;
}

function undoShot() {
  if (currentShots.length === 0) return;

  let last = currentShots.pop();
  let val = (last === "X") ? 10 : Number(last);

  totalScore -= val;
  updateDisplay();
}

function clearAllShots() {
  currentShots = [];
  totalScore = 0;
  updateDisplay();
}

function saveSeries() {
  if (currentShots.length !== maxShots) {
    alert("Du mÃ¥ste registrera exakt " + maxShots + " skott!");
    return;
  }

  let entry = {
    id: Date.now(),
    date: document.getElementById("dateField").value,
    place: document.getElementById("placeField").value,
    weapon: document.getElementById("weaponField").value,
    caliber: document.getElementById("caliberField").value,
    type: document.getElementById("modeField").value,
    shots: [...currentShots],
    score: totalScore
  };

  logbook.push(entry);
  saveLogbook();

  alert("Serie sparad!");

  currentShots = [];
  totalScore = 0;
  updateDisplay();
}

function openLogbook() {
  renderLogbook();
  showPage("pageLogbook");
}

function renderLogbook() {
  let cont = document.getElementById("logContainer");
  cont.innerHTML = "";

  if (logbook.length === 0) {
    cont.innerHTML = "<p>Inga serier sparade Ã¤nnu.</p>";
    return;
  }

  let sorted = [...logbook].sort((a, b) => b.id - a.id);

  sorted.forEach(entry => {
    let div = document.createElement("div");
    div.className = "log-card";

    div.innerHTML = `
      <div><strong>${entry.date}</strong> â€“ ${entry.type}</div>
      <div>Vapen: ${entry.weapon} | Kaliber: ${entry.caliber} | Plats: ${entry.place}</div>
      <div>Skott: ${entry.shots.join(" â€“ ")}</div>
      <div style="margin-top:6px; display:flex; justify-content:space-between;">
        <span>Total: ${entry.score}p</span>
        <button class="log-delete-btn" onclick="deleteEntry(${entry.id})">Ta bort</button>
      </div>
    `;

    cont.appendChild(div);
  });
}

function deleteEntry(id) {
  if (!confirm("Vill du ta bort serien?")) return;

  logbook = logbook.filter(e => e.id !== id);
  saveLogbook();
  renderLogbook();
}

function exportCSV() {
  if (logbook.length === 0) {
    alert("Inga serier att exportera.");
    return;
  }

  let csv = "\uFEFFDatum;Typ;Vapen;Kaliber;Plats;Skott;PoÃ¤ng\n";

  logbook.forEach(e => {
    csv += `${e.date};${e.type};${e.weapon};${e.caliber};${e.place};${e.shots.join("-")};${e.score}\n`;
  });

  let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  let url = URL.createObjectURL(blob);

  let a = document.createElement("a");
  a.href = url;
  a.download = "pistolskytte_loggbok.csv";
  a.click();

  URL.revokeObjectURL(url);
}

function loadLogbook() {
  let s = localStorage.getItem(STORAGE_KEY);
  if (s) {
    try { logbook = JSON.parse(s); }
    catch { logbook = []; }
  }
}

function saveLogbook() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(logbook));
}

</script>

</body>
</html>
